<!DOCTYPE html>
<html>
	<!-- 
Products Display for Assignment2
Author: Deborah Yuan & Evon Diep
Date: 11/18/22
Desc: This html page pulls data from a separate products file (products.json) and displays the files without hardcoding any values. In this particular case, the store has 6 different models of iPhones. The page will present a variety of error messages if the quantities desired for purchase are invalid. This page also contains a form, which will be submitted to the server (server.js), where the data will then be validated. If the user attempts to submit invalid quantities for purchase despite error messages, they will be redirected back to this page to fix their errors. This page also has a navigation bar that allows users to switch between the Home page (index) and the products page (this page). The base template for this site was taken from w3 schools, but has been adequately modified to fit the needs of this store.
-->

	<head>
		<meta charset="utf-8" />

		<meta name="viewport" content="width=device-width, initial-scale=1" />

		<title>Smart Phone Store</title>

		<!-- bootstrap from w3 schools (https://www.w3schools.com/bootstrap/tryit.asp?filename=trybs_temp_store&stacked=h) -->
		<link
			rel="stylesheet"
			href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
		/>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

		<!-- google fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600&display=swap"
			rel="stylesheet"
		/>

		<!-- my own stylesheet (products-style.css) -->
		<link href="products-style.css" rel="stylesheet" />
		<script
			src="../user_registration_info.json"
			type="application/json
  "
		></script>
		<!-- loading in user data from user_registration_info.json -->
		<script src="./functions.js"></script>
		<style>
			/* Remove the navbar's default rounded borders and increase the bottom margin */
			.navbar {
				margin-bottom: 50px;
				border-radius: 0;
			}

			/* Remove the jumbotron's default bottom margin */
			.jumbotron {
				margin-top: 0;
				margin-bottom: 0;
				position: relative;
			}

			/* Add a gray background color and some padding to the footer */
			footer {
				background-color: rgba(0, 0, 0, 0);
			}
		</style>
	</head>
	
<script>

</script>

	<script>
		loadJSON("get_products_data", function (response) {
			// Parsing JSON string into object
			products = JSON.parse(response);
		});
		let params = new URL(document.location).searchParams; // pull params from search URL

		if (params.has(`series`)) {
			series = params.get(`series`);
			console.log("series=" + series);
		}

		var quantities = []; // declaring empty array 'quantities'
		params.forEach(
			// for each iterates through all the keys
			function (value, key) {
				quantities.push(value); // pushes the value to quantities array
			}
		);
		console.log("QTYS=" + quantities);

		// displays error messages
		if (params.has(`error`)) {
			let err_msg = params.get(`error`);
			console.log("ERRMSG=" + err_msg);
			document.getElementById("error").innerHTML = err_msg;
		}

		// Switching between product pages

		/* function section */

		// isNonNegativeInteger tests the input for errors, then returns error messages if any
		function isNonNegativeInteger(queryString, returnErrors = false) {
			errors = []; // assume no errors at first
			if (Number(queryString) != queryString) {
				errors.push("Not a number!"); // Check if string is a number value
			} else {
				if (queryString < 0) errors.push("a Negative value!"); // Check if it is non-negative
				if (parseInt(queryString) != queryString)
					errors.push("Not an integer!"); // Check that it is an integer
			}

			if (returnErrors) {
				return errors;
			} else if (errors.length == 0) {
				return true;
			} else {
				return false;
			}
		}

		// checkQuantityTextbox uses the input to write out errors, adjust textbox quantities, or recolor text/textbox borders
		function checkQuantityTextbox(theTextbox) {
			// Added additional text and font styles to indicate whether quantities were valid or not
			let input_string = theTextbox.value;
			let error_array = isNonNegativeInteger(input_string, true);
			let test = document.getElementsByClassName(theTextbox.name + "").item(0); // let test = 'quantitytextbox'

			/* Having 'quantitytextbox[${i}]_available_message' display a red error message if Available Quantity > Stock, have quantitytextbox readjust to valid quantity, change textbox border to red */
			if (
				Number(input_string) >
				document.getElementById(theTextbox.name + "_available").innerHTML
			) {
				// if user inputted quantity is > products[i].quantity_available, then...
				document.getElementById(theTextbox.name + "_message").outerHTML =
					'<span id="' +
					theTextbox.name +
					'_message" name="' +
					theTextbox.name +
					'_message"><font color="red"><b>We don\'t have ' +
					input_string +
					" available.</b></font></span>"; // change quantitytextbox[${i}]_available_message's outerHTML to write that x quantity is not available
				var extra =
					input_string -
					document.getElementById(theTextbox.name + "_available").innerHTML; // defining extra, which is the user inputted quantity - products[i].quantity_available
				setTimeout(function () {
					// delays this code for a bit (500) so the user inputted quantity that exceeds stock isn't INSTANTLY changed
					test.value = input_string - extra; // quantitytextbox = user inputted quantity - the # of products that exceeds stock
				}, 500);
				test.style.borderColor = "red"; // changes quantitytextbox's border to red
				return;
			} else {
				test.style.borderColor = "black"; // if the quantity is fixed, changes quantitytextbox's border to red
			}

			if (error_array.length == 0) {
				// If there are no errors...
				document.getElementById(theTextbox.name + "_message").innerHTML =
					"You want <b>" + input_string + "</b>"; //  tell the user how much they want
			} else {
				// tell the user what the errors are and make the text red
				document.getElementById(theTextbox.name + "_message").innerHTML =
					'<font color="red"><b>Quantity is ' +
					error_array.join("; ") +
					"</b></font>";
			}
		}

		/* allows for us to create an error alert based off of the results of the server's validataion*/
		//let params = (new URL(document.location)).searchParams;

		console.log("Params=" + params); // shows what the params are in the console
		// Check for an error and if so, display error message

    if (typeof document.cookie != "undefined" && document.cookie!= "") {
					active_user = document.cookie;
				}
	</script>

	<!-- navigation bar from w3 schools -->
	<nav class="navbar navbar-inverse">
		<div class="container-fluid">
			<div class="navbar-header">
				<button
					type="button"
					class="navbar-toggle"
					data-toggle="collapse"
					data-target="#myNavbar"
				>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand active" href="./">
					<!-- corner navbar Apple icon -->
					<img
						src="https://raw.githubusercontent.com/deborahyuan/Assignment1imgs/main/Assignment1_images/Apple-Logo.png"
						width="20"
						alt=""
				/></a>
			</div>
		<div class="collapse navbar-collapse" id="myNavbar">
			<ul class="nav navbar-nav">
				<li><a href="./products_display.html">Home</a></li>
			</ul>
			<ul class="nav navbar-nav">
				<!-- clicking this 'tab' leads to products display -->
				<script>
					if (typeof series != "undefined" && series == "iPhone") {
						document.write(
							`<li class="active" id="iPhonetab"><a href="./products_display.html?series=iPhone">iPhone</a></li>`
						);
					} else {
						document.write(
							`<li id="iPhonetab"><a href="./products_display.html?series=iPhone">iPhone</a></li>`
						);
					}
				</script>
			</ul>
			<ul class="nav navbar-nav">
				<!-- clicking this 'tab' leads to products display -->
				<script>
					if (typeof series != "undefined" && series == "iPad") {
						document.write(`
      <li class="active" id="iPadtab"><a href="./products_display.html?series=iPad">iPad</a></li>`);
					} else {
						document.write(`
      <li id="iPadtab"><a href="./products_display.html?series=iPad">iPad</a></li>`);
					}
				</script>
			</ul>
			<ul class="nav navbar-nav">
				<!-- clicking this 'tab' leads to products display -->
				<script>
					if (typeof series != "undefined" && series == "Mac") {
						document.write(`
      <li class="active" id="Mactab"><a href="./products_display.html?series=Mac">Mac</a></li>`);
					} else {
						document.write(`
          <li id="Mactab"><a href="./products_display.html?series=Mac">Mac</a></li>`);
					}
				</script>
			</ul>
			<ul class="nav navbar-nav navbar-right">
				<ul class="nav navbar-nav">
					<script>
						if (typeof active_user != "undefined") {
							document.write(
								`<li><a href="./loginsuccess">&emsp;<span class="glyphicon glyphicon-user"></span>&emsp;My Account&emsp;</a></li>`
							);
						} else {
							document.write(
								`<li><a href="./login">&emsp;<span class="glyphicon glyphicon-user"></span>&emsp;Login&emsp;</a></li>`
							);
						}
					</script>
				</ul>
				<ul class="nav navbar-nav">
					<li>
						<a href="./cart"
							>&emsp;<span class="glyphicon glyphicon-shopping-cart"></span
							>&emsp;Cart&emsp;</a
						>
					</li>
				</ul>
			</ul>
		</div>
	</nav>

	<div class="top-btn"> <!-- code and css partially borrowed from https://codepen.io/rafi_kadir/pen/oNgOyZb --> 
		<i class="fas fa-arrow-up">â†‘</i>
  </div>
  <script>
document.addEventListener("scroll", handleScroll); // code modified from (https://dev.to/ljcdev/scroll-to-top-button-in-vanilla-js-beginners-2nc)
// get a reference to our predefined button
var scrollToTopBtn = document.querySelector(".top-btn");

function handleScroll() {
  var scrollableHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
  var GOLDEN_RATIO = 0.5;

  if ((document.documentElement.scrollTop / scrollableHeight ) > GOLDEN_RATIO) {
    //show button
    if(!scrollToTopBtn.classList.contains("showScrollBtn"))
    scrollToTopBtn.classList.add("showScrollBtn")
  } else {
    //hide button
    if(scrollToTopBtn.classList.contains("showScrollBtn"))
    scrollToTopBtn.classList.remove("showScrollBtn")
  }
}

scrollToTopBtn.addEventListener("click", scrollToTop);

function scrollToTop() {
  window.scrollTo({
    top: 0,
    behavior: "smooth"
  });
}


	// HEAVILY MODIFIED, inspired by emkey08's response (https://stackoverflow.com/questions/469357/html-text-input-allow-only-numeric-input)
	function setInputFilter(textbox, inputFilter) {
		[
			"input",
			"keydown",
			"keyup",
			"mousedown",
			"mouseup",
			"select",
			"contextmenu",
			"drop",
			"focusout",
		].forEach(function (event) {
			textbox.addEventListener(event, function (e) {
				if (inputFilter(this.value)) {
					// Accepted value
					if (
						[
							"input",
							"keydown",
							"keyup",
							"mousedown",
							"mouseup",
							"select",
							"contextmenu",
							"drop",
							"focusout",
						].indexOf(e.type) >= 0
					) {
						this.classList.remove("input-error");
						this.setCustomValidity("");
					}
					this.oldValue = this.value;
					this.oldSelectionStart = this.selectionStart;
					this.oldSelectionEnd = this.selectionEnd;
				} else if (this.hasOwnProperty("oldValue")) {
					// Rejected value
					this.classList.add("input-error");
					console.log("What is=" + this.value);
					if (/^[1-9]\d*(\.\d+)?$/.test(this.value) == false) {
						// must be a number
						errMsg = "Not a Number!";
					} else if (/^-?\d*$/.test(this.value) == false) {
						// must be an integer
						errMsg = "Not an Integer!";
					} else if (/^\d*$/.test(this.value) == false) {
						// must be a non negative integer
						errMsg = "Can't be negative!";
					} else {
						errMsg = "Unknown Error";
					}
					console.log("errormessage=" + errMsg);
					this.setCustomValidity(errMsg);
					this.reportValidity();
				} else {
					// Rejected value - nothing to restore
					this.value = "";
				}
			});
		});	
	}
;
  </script>

	<script>
		if (params.has(`series`)) {
			let products_S = products[series]; // new product variable that accounts for the series

			// Modified code by Dan Port Assignment 1 to make textboxes sticky
			for (i = 0; i < products_S.length; i++) {
				if (params.has(`error`)) {
					stickyUser = quantities[i];
					console.log("this: " + stickyUser);
					quantity_form[`quantitytextbox[${i}]`].value = stickyUser;
				}
			}
			console.log("hi=" + products_S[1]["name"]);

			document.write(`
<div class="container text-center" style="padding-bottom: 50px;">
  <h1 style="font-size: 6em;">${series}</h1>
  <p style="font-size: 2em;">Models for Sale</p>
</div>

<!-- formatting provided by w3 schools -->
<form name='quantity_form' action="/addtocart" method="POST">
<input type="hidden" name="series" value=${series}>
  <!-- start of the form -->`);

			for (i in products_S) {
				// for loop that loops x amount of times, depending on the number of products in 'products.json'
				row = "";
				if (parseInt(i / 3) == i / 3) {
					//
					document.write(`<div class="container">
            <div class="row">`);
				}
			}
			for (i in products_S) {
				document.write(`
          <div class="col-sm-4" >
          <div class="panel panel-primary" style="border-radius: 10px 10px 10px 10px; overflow: hidden; box-shadow: 0 0 30px rgba(0, 0, 0, 0.30); border: white;">
          <div class="panel-heading" style="background-color:black"><b>${
						products_S[i].name
					}</b></div> <!-- some inline css to override the template defaults -->
          <div class="panel-body"><img src="${
						products_S[i].image
					}" class="img-responsive" style="width:100%" alt="Image"></div>
          <div class="panel-footer"><h2 id="price">$${
						products_S[i].price
					}</h2><BR>
          <label id ="quantitylabel" name="quantity${[
						i,
					]}_label">Quantity Desired</label><BR>
          <span id="quantitytextbox[${i}]_message" name="quantitytextbox[${i}]_message">Enter a quantity</span><BR><BR>
          <input type="text" id ="quantitytextbox[${i}]" class="quantitytextbox[${i}]" name="quantitytextbox[${i}]"></input><BR><BR>
          <div id="qtyform">
          <label id ="quantitytextbox[${i}]_available_message" name="quantitytextbox[${i}]_available_message">Quantity Available</label><BR>
          <p id ="quantitytextbox[${i}]_available" name ="quantitytextbox[${i}]_available">${
					products_S[i].quantity_available
				}</p>
          <label id ="quantitysoldemessage" name="quantity_sold[${i}]_message">Quantity Sold</label><BR>
          <p>${products_S[i].quantity_sold}</p>
          </div>
         </div>
         </div>
          </div>
        `);
			}
			document.write(`
  </div>
  <br><br>
  `)

	setInputFilter(
		document.getElementById("quantitytextbox[1]"),
		function (value) {
			if (/^[1-9]\d*(\.\d+)?$/.test(value) == false) {
				// must be a number
				return /^[1-9]\d*(\.\d+)?$/.test(value);
			} else if (/^-?\d*$/.test(value) == false) {
				// must be an integer
				return /^-?\d*$/.test(value);
			} else if (/^\d*$/.test(value) == false) {
				// must be a non negative integer
				return /^\d*$/.test(value);
			} else {
				return true;
			}
		}
	);
	document.write(`

 <!-- footer -->
  <footer class="container-fluid text-center">
   <!-- if there are any errors that prevent the user from continuing to login, they will show up here -->
    <h2 id="error"></h2>
    <input type="submit" value='Purchase' id="button" class="button"></input>
</form>
<h3 style="padding: 10px;">
  <B>Apple Online Store</B>
</h3>

</footer>
`)

		} else {
			document.write(`
<div class="container text-center" style="padding-bottom: 50px;">
  <h1 style="font-size: 6em;">Welcome to the Apple Store</h1>
  <p style="font-size: 2em;">Choose From the Series Below</p>
</div>

<div class="container">
  <div class="row justify-content-md-center">
      <div class="col-sm-4" >
        <div class="panel panel-primary" style="border-radius: 10px 10px 10px 10px; overflow: hidden; box-shadow: 0 0 30px rgba(0, 0, 0, 0.30); border: white">
        <div class="panel-heading" style="background-color:black"><b>iPhone</b></div> <!-- some inline css to override the template defaults -->
        <div class="panel-body"><img src="https://raw.githubusercontent.com/deborahyuan/Assignment1imgs/main/Assignment3imgs/products_display/iphone-14-lineup.png" class="img-responsive" style="width:100%" alt="Image"></div>
     <div class="panel-footer"><BR><h2 class="underlinecss" style="text-align:center;"><a href="./products_display.html?series=iPhone" style = "color: black; text-decoration: none;">Shop for iPhones âžœ</a></h2><BR>
          </div>
        </div>
      </div>
      <div class="col-sm-4" >
        <div class="panel panel-primary" style="border-radius: 10px 10px 10px 10px; overflow: hidden; box-shadow: 0 0 30px rgba(0, 0, 0, 0.30); border: white">
        <div class="panel-heading" style="background-color:black"><b>iPad</b></div> <!-- some inline css to override the template defaults -->
        <div class="panel-body"><img src="https://raw.githubusercontent.com/deborahyuan/Assignment1imgs/main/Assignment3imgs/products_display/iPad-lineup.png" class="img-responsive" style="width:100%" alt="Image"></div>
        <div class="panel-footer"><BR><h2 class="underlinecss" style="text-align:center;"><a href="./products_display.html?series=iPad" style = "color: black; text-decoration: none;">Shop for iPads âžœ</a></h2><BR>
          </div>
        </div>
      </div>
      <div class="col-sm-4" >
        <div class="panel panel-primary" style="border-radius: 10px 10px 10px 10px; overflow: hidden; box-shadow: 0 0 30px rgba(0, 0, 0, 0.30); border: white">
        <div class="panel-heading" style="background-color:black"><b>Mac</b></div> <!-- some inline css to override the template defaults -->
        <div class="panel-body"><img src="https://raw.githubusercontent.com/deborahyuan/Assignment1imgs/main/Assignment3imgs/products_display/Mac-lineup.png" class="img-responsive" style="width:100%" alt="Image"></div>
        <div class="panel-footer"><BR><h2 class="underlinecss" style="text-align:center;"><a href="./products_display.html?series=Mac" style = "color: black; text-decoration: none;"">Shop for Macs âžœ</a></h2></ul><BR>
          </div>
        </div>
      </div>
        </div>
        </div>
        
  <!-- footer -->
  <footer class="container-fluid text-center">
<h3 style="padding: 10px;">
  <B>Apple Online Store</B>
</h3>`);
		}
	</script>
</html>